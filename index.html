<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Thehiddenearth Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body, #map { margin:0; height:100%; }
    .popup img { width:100%; border-radius:8px; margin-bottom:6px; }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<script>
  // 1) Paste your NEW public token between the quotes:
  mapboxgl.accessToken = 'pk.eyJ1IjoidGhlaGlkZGVudHJhaWwiLCJhIjoiY21mazBhMWg2MGFvaDJrc2hxN3VnZWV4eCJ9.gTrki2mEVtBCoiZ2Io--aw';

  // 2) Use your Mapbox Studio style URL (quoted):
  const styleUrl = 'mapbox://styles/thehiddentrail/cmffmtxuk000801qyclwyh9tz';

  const map = new mapboxgl.Map({
    container: 'map',
    style: styleUrl,
    center: [5.324, 60.397],  // Bergen
    zoom: 12,
    pitch: 60,                // camera tilt so 3D is visible
    bearing: -20,
    antialias: true
  });

  map.on('load', () => {
    // --- Terrain (for hills) ---
    if (!map.getSource('mapbox-dem')) {
      map.addSource('mapbox-dem', {
        type: 'raster-dem',
        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
        tileSize: 512, maxzoom: 14
      });
      map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.0 });
    }

    // DEM source + Terrain (elevates the ground surface)
    if (!map.getSource('mapbox-dem')) {
      map.addSource('mapbox-dem', {
        type: 'raster-dem',
        url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
        tileSize: 512,
        maxzoom: 14
      });
      // exaggeration 1.3–1.8 makes relief pop more
      map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.4 });
    }

    // Optional: hillshade overlay for more relief contrast
    if (!map.getLayer('hillshade')) {
      map.addLayer({
        id: 'hillshade',
        type: 'hillshade',
        source: 'mapbox-dem',
        layout: { visibility: 'visible' },
        paint: { 'hillshade-exaggeration': 0.6 }
      }, /* place before labels if you want */);
    }

    // Optional: sky for pitched camera
    if (!map.getLayer('sky')) {
      map.addLayer({
        id: 'sky',
        type: 'sky',
        paint: {
          'sky-type': 'atmosphere',
          'sky-atmosphere-sun': [0.0, 0.0],
          'sky-atmosphere-sun-intensity': 15
        }
      });
    }

    // Ensure camera is pitched to see terrain
    map.setPitch(60);
    map.setBearing(-20);

    // --- 3D buildings (if your style doesn’t already include them) ---
    const labelLayerId = map.getStyle().layers.find(
      l => l.type === 'symbol' && l.layout && l.layout['text-field']
    )?.id;

    if (!map.getLayer('3d-buildings')) {
      map.addLayer({
        id: '3d-buildings',
        source: 'composite',
        'source-layer': 'building',
        filter: ['==', ['get', 'extrude'], 'true'],
        type: 'fill-extrusion',
        minzoom: 15,
        paint: {
          'fill-extrusion-color': '#bbb',
          'fill-extrusion-height': ['get', 'height'],
          'fill-extrusion-base': ['get', 'min_height'],
          'fill-extrusion-opacity': 0.6
        }
      }, labelLayerId);
    }

    // --- Your points (clustered) ---
    map.addSource('places', {
      type: 'geojson',
      data: 'places.geojson',     // keep this filename in the repo root
      cluster: true,
      clusterMaxZoom: 14,
      clusterRadius: 50
    });

    map.addLayer({
      id: 'clusters',
      type: 'circle',
      source: 'places',
      filter: ['has', 'point_count'],
      paint: {
        'circle-radius': ['step', ['get', 'point_count'], 16, 50, 22, 150, 28],
        'circle-color': ['step', ['get', 'point_count'], '#a0c4ff', 50, '#5fa8ff', 150, '#2d6cdf']
      }
    });

    map.addLayer({
      id: 'cluster-count',
      type: 'symbol',
      source: 'places',
      filter: ['has', 'point_count'],
      layout: { 'text-field': ['get', 'point_count_abbreviated'], 'text-size': 12 }
    });

    map.addLayer({
      id: 'unclustered',
      type: 'circle',
      source: 'places',
      filter: ['!', ['has', 'point_count']],
      paint: { 'circle-radius': 6, 'circle-color': '#ff4d4d' }
    });

    map.on('click', 'clusters', (e) => {
      const f = map.queryRenderedFeatures(e.point, { layers: ['clusters'] })[0];
      map.getSource('places').getClusterExpansionZoom(f.properties.cluster_id, (err, zoom) => {
        if (!err) map.easeTo({ center: f.geometry.coordinates, zoom });
      });
    });

    map.on('click', 'unclustered', (e) => {
      const f = e.features[0];
      const p = f.properties || {};
      const html = `
        <div class="popup">
          ${p.photo ? `<img src="${p.photo}"/>` : ""}
          <strong>${p.name || ''}</strong><br/>
          ${p.subtitle || ""}<br/>
          ${p.url ? `<a href="${p.url}" target="_blank">More info</a>` : ""}
        </div>`;
      new mapboxgl.Popup().setLngLat(f.geometry.coordinates).setHTML(html).addTo(map);
    });
  });

  map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }));

  map.addControl(new mapboxgl.GeolocateControl({
  positionOptions: { enableHighAccuracy: true },
  trackUserLocation: true,
  showUserHeading: true
  }));
</script>
</body>
</html>


