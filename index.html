<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Thehiddenearth Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
  <style>
    html, body, #map { margin:0; height:100%; }
    .popup img { width:100%; border-radius:8px; margin-bottom:6px; }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<script>
  // TODO: rotate/restrict this to your GitHub Pages domain in Mapbox dashboard
  mapboxgl.accessToken = 'pk.eyJ1IjoidGhlaGlkZGVudHJhaWwiLCJhIjoiY21mazBhMWg2MGFvaDJrc2hxN3VnZWV4eCJ9.gTrki2mEVtBCoiZ2Io--aw';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/thehiddentrail/cmffmtxuk000801qyclwyh9tz',
    center: [5.324, 60.397],   // Bergen
    zoom: 12,
    pitch: 60,                 // show 3D by default
    bearing: -20,
    antialias: true
  });

  map.on('load', () => {
    // --- Terrain (elevates hills/mountains) ---
    map.addSource('mapbox-dem', {
      type: 'raster-dem',
      url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
      tileSize: 512,
      maxzoom: 14
    });
    map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.4 });

    // Optional: hillshade for more relief contrast
    map.addLayer({
      id: 'hillshade',
      type: 'hillshade',
      source: 'mapbox-dem',
      paint: { 'hillshade-exaggeration': 0.6 }
    });

    // Optional: sky for pitched camera
    map.addLayer({
      id: 'sky',
      type: 'sky',
      paint: {
        'sky-type': 'atmosphere',
        'sky-atmosphere-sun': [0.0, 0.0],
        'sky-atmosphere-sun-intensity': 15
      }
    });

    // --- 3D buildings (if your style doesnâ€™t already include them) ---
    const labelLayerId = map.getStyle().layers.find(
      l => l.type === 'symbol' && l.layout && l.layout['text-field']
    )?.id;
    if (!map.getLayer('3d-buildings')) {
      map.addLayer({
        id: '3d-buildings',
        source: 'composite',
        'source-layer': 'building',
        type: 'fill-extrusion',
        minzoom: 15,
        filter: ['==', ['get', 'extrude'], 'true'],
        paint: {
          'fill-extrusion-color': '#bbb',
          'fill-extrusion-height': ['get', 'height'],
          'fill-extrusion-base': ['get', 'min_height'],
          'fill-extrusion-opacity': 0.6
        }
      }, labelLayerId);
    }

    // --- Your points (clustered) ---
    map.addSource('places', {
      type: 'geojson',
      data: 'places.geojson',
      cluster: true,
      clusterMaxZoom: 14,
      clusterRadius: 50
    });

    // Clusters
    map.addLayer({
      id: 'clusters',
      type: 'circle',
      source: 'places',
      filter: ['has', 'point_count'],
      paint: {
        'circle-radius': ['step', ['get', 'point_count'], 16, 50, 22, 150, 28],
        'circle-color': ['step', ['get', 'point_count'], '#a0c4ff', 50, '#5fa8ff', 150, '#2d6cdf']
      }
    });

    // Cluster counts
    map.addLayer({
      id: 'cluster-count',
      type: 'symbol',
      source: 'places',
      filter: ['has', 'point_count'],
      layout: { 'text-field': ['get', 'point_count_abbreviated'], 'text-size': 12 }
    });

    // --- Bigger unclustered points (circle version) ---
    map.addLayer({
      id: 'unclustered',
      type: 'circle',
      source: 'places',
      filter: ['!', ['has', 'point_count']],
      paint: {
        'circle-radius': [
          'interpolate', ['linear'], ['zoom'],
          10, 8,   // smaller zoom
          12, 12,
          14, 18,
          16, 26   // close-in zoom
        ],
        'circle-color': '#ff4d4d',
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 2
      }
    });

    // (Optional) Use a big custom icon instead of circles:
    // map.loadImage('img/pin@2x.png', (err, image) => {
    //   if (err) throw err;
    //   if (!map.hasImage('poi-pin')) map.addImage('poi-pin', image);
    //   map.addLayer({
    //     id: 'unclustered',
    //     type: 'symbol',
    //     source: 'places',
    //     filter: ['!', ['has', 'point_count']],
    //     layout: {
    //       'icon-image': 'poi-pin',
    //       'icon-size': ['interpolate', ['linear'], ['zoom'], 10, 0.35, 14, 0.5, 16, 0.7],
    //       'icon-allow-overlap': true,
    //       'icon-ignore-placement': true
    //     }
    //   });
    // });

    // Interactions
    map.on('click', 'clusters', (e) => {
      const f = map.queryRenderedFeatures(e.point, { layers: ['clusters'] })[0];
      map.getSource('places').getClusterExpansionZoom(f.properties.cluster_id, (err, zoom) => {
        if (!err) map.easeTo({ center: f.geometry.coordinates, zoom });
      });
    });

    map.on('click', 'unclustered', (e) => {
      const f = e.features[0];
      const p = f.properties || {};
      const html = `
        <div class="popup">
          ${p.photo ? `<img src="${p.photo}"/>` : ""}
          <strong>${p.name || ''}</strong><br/>
          ${p.subtitle || ""}<br/>
          ${p.url ? `<a href="${p.url}" target="_blank">More info</a>` : ""}
        </div>`;
      new mapboxgl.Popup().setLngLat(f.geometry.coordinates).setHTML(html).addTo(map);
    });
  });

  // UI controls
  map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }));
  map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true,
    showUserHeading: true
  }));
</script>
</body>
</html>
